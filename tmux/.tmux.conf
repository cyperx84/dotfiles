# ======================
# CORE CONFIGURATION
# ======================

# Remap prefix from Ctrl-B to Ctrl-A
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix  # Send prefix when pressed twice

# Terminal configuration for Ghostty (truecolor support)
set -g default-terminal "tmux-256color"
set-option -sa terminal-features ',ghostty:RGB'
set-option -sa terminal-features ',xterm-ghostty:RGB'  
set-option -sa terminal-overrides ',ghostty:Tc'
set-option -sa terminal-overrides ',xterm-ghostty:Tc'
set-option -sa terminal-overrides ',*256col*:Tc'
set -gq allow-passthrough on  # Allow terminal pass-through

set-option -g focus-events on

# Reload configuration shortcut
bind r source-file ~/.tmux.conf \; display "ðŸš€ Config reloaded."

# ======================
# NAVIGATION & KEYBINDINGS
# ======================

# Vi-style pane navigation
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Direct window selection by letter (no prefix required)
# Alt+j/k/l/u/i/o acts like Ctrl+a 1-6 (select window)
# Unbind default Alt+number bindings
unbind -n M-0
unbind -n M-1
unbind -n M-2
unbind -n M-3
unbind -n M-4
unbind -n M-5
unbind -n M-6
unbind -n M-7
unbind -n M-8
unbind -n M-9

bind-key -n M-j select-window -t :1
bind-key -n M-k select-window -t :2
bind-key -n M-l select-window -t :3
bind-key -n M-u select-window -t :4
bind-key -n M-i select-window -t :5
bind-key -n M-o select-window -t :6

# Quick splits without prefix (preserve current path)
bind-key -n M-s split-window -c "#{pane_current_path}"
bind-key -n M-v split-window -h -c "#{pane_current_path}"

# Create new window without prefix (preserve current path)
unbind c
bind-key -n M-c new-window -c "#{pane_current_path}"

# Window/pane management without prefix
bind-key -n M-x kill-window  # Close current window
bind-key -n M-Tab last-window  # Switch to last window
bind-key -n M-w resize-pane -Z  # Toggle pane zoom
bind-key -n M-r break-pane  # Break pane to new window
bind-key -n M-q detach-client  # Detach from tmux server

# Toggle status bar visibility
bind-key b set-option "status"

# Vim navigator plugin custom bindings
set -g @vim_navigator_mapping_left "C-Left C-h"
set -g @vim_navigator_mapping_right "C-Right C-l"
set -g @vim_navigator_mapping_up "C-k"
set -g @vim_navigator_mapping_down "C-j"
set -g @vim_navigator_mapping_prev ""  # Disable C-\ binding
set -g @vim_navigator_prefix_mapping_clear_screen ""

# Remove conflicting 'd' binding (was creating docs window)
unbind d

# Pane resizing with repeatable binds (-r)
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5
bind -r C-h resize-pane -L 5
bind -r C-l resize-pane -R 5

# Enter copy mode with Alt+/
bind-key -n M-, copy-mode  # Enter copy mode (no auto page-up)

# ======================
# WINDOW MANAGEMENT
# ======================

# Custom split/window creation (preserve current path)
unbind s
unbind v
# bind c run-shell "~/.config/sesh/scripts/utils/sesh_create_new.sh"  # Create new sesh session
bind s split-window -c "#{pane_current_path}"  # Vertical split
bind v split-window -h -c "#{pane_current_path}"  # Horizontal split

# Environment propagation
set-option -ga update-environment "VIRTUAL_ENV"

# Indexing configuration (start from 1)
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on  # Auto-renumber windows

# Session/window management
bind-key x kill-pane  # Skip confirmation prompt
set -g detach-on-destroy off  # Keep tmux open when session closes

# ======================
# SESSION SWITCHING
# ======================

# Sesh quick session switcher (Alt+e, or Cmd+e via Ghostty)
# Enhanced with CyperX theme: multi-mode display, git status, resources, containers, dev env
bind-key -n M-e run-shell "~/.config/sesh/scripts/core/sesh_switcher.sh"


# Sesh last session (Alt + p)
bind-key -n M-p run-shell "sesh last || true"

# Session management shortcuts
bind -N "new session with name" N command-prompt -p "New session name:" "new-session -d -s '%%'"
bind -N "rename current session" R command-prompt -I "#S" "rename-session '%%'"
bind -N "kill current session" X confirm-before -p "Kill session #S? (y/n)" kill-session

# ======================
# SESSION HELPER FUNCTIONS
# ======================

# Session information display
bind -N "show session info" I run-shell "tmux display-message 'Session: #S | Windows: #{session_windows} | Path: #{pane_current_path}'"

# Detach and keep session running
bind -N "detach session" D detach-client

# ======================
# SESSION MANAGEMENT QUICK REFERENCE
# ======================
#
# ðŸš€ Sesh Quick Switcher:
#   Cmd+E               - Open sesh switcher (global, works anywhere)
#   Prefix + e          - Open sesh switcher (traditional)
#   Esc                 - Close switcher
#
#   Fuzzy filter options (within sesh switcher):
#     Alt+n  - New session            | Alt+k  - Kill session
#     Ctrl+b - All sessions           | Ctrl+t - Tmux only  | Ctrl+/ - All sessions
#     Ctrl+r - Detailed view          | Ctrl+s - Sort by name | Ctrl+d/u - Scroll preview
#
# ðŸ“Š Session Management Shortcuts:
#   Prefix + L - Jump to last session (via sesh)
#   Prefix + N - New named session
#   Prefix + R - Rename current session
#   Prefix + X - Kill current session (with confirmation)
#   Prefix + I - Show session info
#   Prefix + D - Detach session
#
# ðŸ”§ Shell Aliases (in zsh):
#   sl              - List sessions (compact)
#   sc <session>    - Connect to session
#   sd              - Fuzzy connect with fzf
#   sesh-info       - Detailed session info
#   sesh-current    - Info about current session
#   sesh-kill       - Kill specific session
#
# ======================
# PLUGIN CONFIGURATION
# ======================

set -g @continuum-restore 'on'

# TPM auto-install
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Plugin list
set -g @plugin 'tmux-plugins/tpm'
unbind 'o'  # Free up key for plugins
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'
set -g @plugin 'omerxx/tmux-floax'

# Floax plugin configuration
set -g @floax-width '60%'
set -g @floax-height '60%'
set -g @floax-border-color 'magenta'
set -g @floax-text-color 'blue'
set -g @floax-bind 'p'
set -g @floax-change-path 'true'

# Resurrect plugin settings
set -g @resurrect-strategy-nvim 'session'

# Minimal status bar configuration
set -g @plugin 'niksingh710/minimal-tmux-status'
set -g @minimal-tmux-fg "#000000"
set -g @minimal-tmux-bg "#00FF00"
set -g @minimal-tmux-justify "centre"
set -g @minimal-tmux-indicator-str "ó±“‡TMUXó±“‡"
set -g @minimal-tmux-indicator true
set -g @minimal-tmux-status "bottom"
set -g @minimal-tmux-right false
set -g @minimal-tmux-left true
set -g @minimal-tmux-expanded-icon "ó°Š“ "
set -g @minimal-tmux-show-expanded-icons-for-all-tabs false
set -g @minimal-tmux-status-right-extra "ó±“‡TMUXó±“‡"
set -g @minimal-tmux-status-left-extra ""
set -g @minimal-tmux-use-arrow  true
set -g @minimal-tmux-right-arrow "î‚´"
set -g @minimal-tmux-left-arrow "î‚¶"

# Initialize TPM
run '~/.tmux/plugins/tpm/tpm'

