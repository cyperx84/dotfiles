# PR Submission Guide: `getBufferContent` Tool

## Step-by-Step Instructions

### 1. Fork and Clone

```bash
# Fork on GitHub first, then:
git clone https://github.com/YOUR_USERNAME/claudecode.nvim.git
cd claudecode.nvim
git remote add upstream https://github.com/coder/claudecode.nvim.git
```

### 2. Create Feature Branch

```bash
git checkout -b feat/get-buffer-content
```

### 3. Copy Implementation Files

```bash
# Copy the tool file from your local installation
cp ~/.local/share/nvim/lazy/claudecode.nvim/lua/claudecode/tools/get_buffer_content.lua \
   lua/claudecode/tools/get_buffer_content.lua

# The init.lua change needs to be made in the fork
```

### 4. Update tools/init.lua

Add this line after `save_document` registration:

```lua
M.register(require("claudecode.tools.get_buffer_content"))
```

### 5. Run Tests

```bash
# Run linting first
make check

# Run all tests
make test

# Or test the specific module
nvim --headless -c "lua print(vim.inspect(require('claudecode.tools.get_buffer_content')))" -c "qa"
```

### 6. Create Test File (Recommended)

Create `tests/unit/tools/get_buffer_content_spec.lua`:

```lua
describe("getBufferContent tool", function()
  local tool

  before_each(function()
    tool = require("claudecode.tools.get_buffer_content")
  end)

  it("should have correct name", function()
    assert.equals("getBufferContent", tool.name)
  end)

  it("should have valid schema", function()
    assert.is_not_nil(tool.schema)
    assert.is_not_nil(tool.schema.inputSchema)
    assert.equals("object", tool.schema.inputSchema.type)
  end)

  it("should return current buffer content when no params", function()
    -- Create a test buffer
    local buf = vim.api.nvim_create_buf(true, false)
    vim.api.nvim_buf_set_lines(buf, 0, -1, false, {"line 1", "line 2"})
    vim.api.nvim_set_current_buf(buf)

    local result = tool.handler({})
    assert.is_not_nil(result.content)
    assert.equals("text", result.content[1].type)

    local decoded = vim.json.decode(result.content[1].text)
    assert.equals(2, decoded.lineCount)
    assert.equals("line 1\nline 2", decoded.content)

    -- Cleanup
    vim.api.nvim_buf_delete(buf, { force = true })
  end)

  it("should support line range filtering", function()
    local buf = vim.api.nvim_create_buf(true, false)
    vim.api.nvim_buf_set_lines(buf, 0, -1, false, {"a", "b", "c", "d", "e"})
    vim.api.nvim_set_current_buf(buf)

    local result = tool.handler({ startLine = 1, endLine = 3 })
    local decoded = vim.json.decode(result.content[1].text)
    assert.equals(2, decoded.lineCount)
    assert.equals("b\nc", decoded.content)

    vim.api.nvim_buf_delete(buf, { force = true })
  end)

  it("should return error for non-existent buffer", function()
    local success, err = tool.handler({ filePath = "/nonexistent/path.txt" })
    assert.is_false(success)
    assert.equals(-32602, err.code)
  end)
end)
```

### 7. Format Code

```bash
make format
```

### 8. Commit Changes

```bash
git add lua/claudecode/tools/get_buffer_content.lua
git add lua/claudecode/tools/init.lua
git add tests/unit/tools/get_buffer_content_spec.lua  # if created

git commit -m "feat(tools): add getBufferContent MCP tool

Add new MCP tool for reading buffer contents, enabling Claude Code to:
- Read full content of any open buffer (including virtual buffers)
- Access unsaved changes in modified buffers
- Filter by line range for targeted context
- Find buffers by path or buffer number

This complements getOpenEditors and getCurrentSelection by providing
full buffer content access, which is especially useful for:
- Virtual buffers (CodeCompanion, scratch, etc.)
- Reading unsaved modifications
- Getting context around cursor position

Closes #XXX"
```

### 9. Push and Create PR

```bash
git push origin feat/get-buffer-content
```

Then go to GitHub and create the PR.

---

## PR Template

```markdown
## Summary

Adds `getBufferContent` MCP tool for reading buffer contents, complementing existing tools like `getOpenEditors` and `getCurrentSelection`.

## Motivation

Claude Code currently cannot:
- Read virtual buffers (no file path)
- Access unsaved buffer modifications
- Get full buffer content (only selections)

This tool enables full buffer content access through the existing MCP connection.

## Changes

- Added `lua/claudecode/tools/get_buffer_content.lua` - new MCP tool
- Updated `lua/claudecode/tools/init.lua` - registered new tool
- Added tests for the new tool

## API

```typescript
getBufferContent({
  filePath?: string,  // Find by path (partial match supported)
  bufnr?: number,     // Find by buffer number
  startLine?: number, // Line range start (0-indexed)
  endLine?: number    // Line range end (exclusive, -1 = EOF)
})
```

## Testing

- [x] `make check` passes
- [x] `make test` passes
- [x] Manually tested with Claude Code CLI
- [x] Works with virtual buffers
- [x] Error handling verified

## Related Issues

Closes #XXX (if you create the issue first)
```

---

## Quick Commands Reference

```bash
# From your fork directory:
make check    # Lint
make format   # Format code
make test     # Run tests

# Test tool manually
nvim --headless -c "lua print(vim.inspect(require('claudecode.tools.get_buffer_content')))" -c "qa"
```

---

## Files Changed Summary

| File | Change |
|------|--------|
| `lua/claudecode/tools/get_buffer_content.lua` | New file (147 lines) |
| `lua/claudecode/tools/init.lua` | +1 line (register tool) |
| `tests/unit/tools/get_buffer_content_spec.lua` | New file (optional) |
